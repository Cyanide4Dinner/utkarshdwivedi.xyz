+++
title = "Experimenting with eBPF"
date = "2022-07-03T15:48:23+05:30"
author = ""
authorTwitter = "" #do not include @
cover = ""
tags = ["linux", "c"]
keywords = ["ebpf"]
description = ""
showFullContent = false
readingTime = false
hideComments = false
draft = true
+++

With a keen interest in Linux and low-level technologies, after following up on the hype of [eBPF](https://ebpf.io/), I realized
the potential it had on drastically altering some of the systems and models we currently use, such as [service mesh sidecars](https://isovalent.com/blog/post/2021-12-08-ebpf-servicemesh/).

Following is my attempt to understand it deeper.

## Environment

I'm using [Manjaro](https://manjaro.org/) 21.3.0 image (minimal, with i3) to play because I need the Linux kernel to
be more recent than `5.8` for trying out the [BPF ring buffer](https://www.kernel.org/doc/html/latest/bpf/ringbuf.html).
Also, the kernel is built wtih `CONFIG_DEBUG_INFO_BTF=y` to utilize BPF CO-RE. [As you can see](https://github.com/libbpf/libbpf#bpf-co-re-compile-once--run-everywhere),
Manjaro has everything already set up for us.

I allocate 15 GB for image -
```bash
qemu-img create -f qcow2 manjaro-linux.img 15G
```

And 2 GB of memory -

```console
qemu-system-x86_64 \
		-m 2048 \
		-enable-kvm \
		-boot d \
		-smp 4 \
		-fsdev local,security_model=mapped,id=fsdev-fs0,path=/home/utkarsh_arch/QEMUShared/ \
		-device virtio-9p-pci,fsdev=fsdev-fs0,mount_tag=/Shared \
		-net user,id=nic0,smb=/home/utkarsh_arch/QEMUShared \
		-hda ~/QEMU/manjaro-linux.img \
		-cdrom ~/Downloads/manjaro-i3-21.3.0-220619-linux515.iso
```
Using [Samba](https://wiki.archlinux.org/title/samba), I can mount to a shared directory in my Manjaro guest as -
```console
sudo mount -t cifs //10.0.2.4/qemu Shared
```

## Setup

My project is structured as follows -

```console
/
└ apps/
└ bin/
└ libbpf/
└ bpftool/
└ output/
└ Makefile
└ vmlinux.h 
```

`bin/` will have the final built applications. `libbpf/` and `bpftool/` are submodules of the repositories of
the same name. `output/` contains the intermediate files of the compilation process while `apps/` has the logic of our applications.

`Makefile` is pretty much the same, with minor modifications, from [`libbpf-bootstrap`][libbpf-bootstrap]
which makes it super easy to start developing BPF applications.

`vmlinux.h` contains the type definitions used by our Linux kernel. It can be generated by -
```console
bpftool btf dump file /sys/kernel/btf/vmlinux format c > vmlinux.h
```

## BPF Program Types
In the latest version of [libbpf](https://github.com/libbpf/libbpf), below are listed the BPF Program Types [^1] -
| BPF Program Types |
| --- |
| `UNSPEC` |
| `SOCKET_FILTER`* |
| `KPROBE` |
| `SCHED_CLS`* |
| `SCHED_ACT`* |
| `TRACEPOINT` |
| `XDP`* |
| `PERF_EVENT` |
| `CGROUP_SKB`* |
| `CGROUP_SOCK` |
| `LWT_IN`* |
| `LWT_OUT`* |
| `LWT_XMIT`* |
| `SOCK_OPS` |
| `SK_SKB` |
| `CGROUP_DEVICE` |
| `SK_MSG` |
| `RAW_TRACEPOINT`* |
| `CGROUP_SOCK_ADDR` |
| `LWT_SEG6LOCAL`* |
| `LIRC_MODE2` |
| `SK_REUSEPORT` |
| `FLOW_DISSECTOR`* |
| `CGROUP_SYSCTL` |
| `RAW_TRACEPOINT_WRITABLE` |
| `CGROUP_SOCKOPT` |
| `TRACING` |
| `STRUCT_OPS`* |
| `EXT` |
| `LSM` |
| `SK_LOOKUP`* |
| `SYSCALL`* |

Following is a table of supported ELF section names - 

| Section Name | BTF Program Type |
| ------- | ------ |
| `socket` | `SOCKET_FILTER` |
| `sk_reuseport/migrate ` | `SK_REUSEPORT` |
| `sk_reuseport` | `SK_REUSEPORT` |
| `kprobe+` | `KPROBE` |
| `uprobe+` | `KPROBE` |
| `kretprobe+ `| `KPROBE` |
| `uretprobe+ ` | `KPROBE` |
| `kprobe.multi+` | `KPROBE` |
| `kretprobe.multi+` | `KPROBE` |
| `usdt+` | `KPROBE` |
| `tc` | `SCHED_CLS` |
| ~~`classifier`~~ | `SCHED_CLS` |
| `action` | `SCHED_ACT` |
| `tracepoint+` | `TRACEPOINT` |
| `tp+` | `TRACEPOINT` |
| `raw_tracepoint+` | `RAW_TRACEPOINT` |
| `raw_tp+` | `RAW_TRACEPOINT` |
| `raw_tracepoint.w+ ` | `RAW_TRACEPOINT_WRITABLE` |
| `raw_tp.w+ ` | `RAW_TRACEPOINT_WRITABLE` |
| `tp_btf+ ` | `TRACING` |
| `fentry+ ` | `TRACING` |
| `fmod_ret+ ` | `TRACING` |
| `fexit+ ` | `TRACING` |
| `fentry.s+ ` | `TRACING` |
| `fmod_ret.s+ ` | `TRACING` |
| `fexit.s+ ` | `TRACING` |
| `freplace+ ` | `EXT` |
| `lsm+ ` | `LSM` |
| `lsm.s+ ` | `LSM` |
| `iter+ ` | `TRACING` |
| `iter.s+ ` | `TRACING` |
| `syscall` | `SYSCALL` |
| `xdp.frags/devmap ` | `XDP` |
| ~~`xdp/devmap`~~ | `XDP` |
| `xdp_devmap/` | `XDP` |
| `xdp.frags/cpumap ` | `XDP` |
| `xdp/cpumap ` | `XDP` |
| ~~`xdp_cpumap/`~~ | `XDP` |
| `xdp.frags ` | `XDP` |
| `xdp` | `XDP` |
| `perf_event` | `PERF_EVENT` |
| `lwt_in` | `LWT_IN` |
| `lwt_out` | `LWT_OUT` |
| `lwt_xmit` | `LWT_XMIT` |
| `lwt_seg6local` | `LWT_SEG6LOCAL` |
| `cgroup_skb/ingress ` | `CGROUP_SKB` |
| `cgroup_skb/egress ` | `CGROUP_SKB` |
| `cgroup/skb ` | `CGROUP_SKB` |
| `cgroup/sock_create ` | `CGROUP_SOCK` |
| `cgroup/sock_release ` | `CGROUP_SOCK` |
| `cgroup/sock ` | `CGROUP_SOCK` |
| `cgroup/post_bind4 ` | `CGROUP_SOCK` |
| `cgroup/post_bind6 ` | `CGROUP_SOCK` |
| `cgroup/dev ` | `CGROUP_DEVICE` |
| `sockops` | `SOCK_OPS` |
| `sk_skb/stream_parser ` | `SK_SKB` |
| `sk_skb/stream_verdict ` | `SK_SKB` |
| `sk_skb` | `SK_SKB` |
| `sk_msg` | `SK_MSG` |
| `lirc_mode2` | `LIRC_MODE2` |
| `flow_dissector` | `FLOW_DISSECTOR` |
| `cgroup/bind4 ` | `CGROUP_SOCK_ADDR` |
| `cgroup/bind6 ` | `CGROUP_SOCK_ADDR` |
| `cgroup/connect4 ` | `CGROUP_SOCK_ADDR` |
| `cgroup/connect6 ` | `CGROUP_SOCK_ADDR` |
| `cgroup/sendmsg4 ` | `CGROUP_SOCK_ADDR` |
| `cgroup/sendmsg6 ` | `CGROUP_SOCK_ADDR` |
| `cgroup/recvmsg4 ` | `CGROUP_SOCK_ADDR` |
| `cgroup/recvmsg6 ` | `CGROUP_SOCK_ADDR` |
| `cgroup/getpeername4 ` | `CGROUP_SOCK_ADDR` |
| `cgroup/getpeername6 ` | `CGROUP_SOCK_ADDR` |
| `cgroup/getsockname4 ` | `CGROUP_SOCK_ADDR` |
| `cgroup/getsockname6 ` | `CGROUP_SOCK_ADDR` |
| `cgroup/sysctl ` | `CGROUP_SYSCTL` |
| `cgroup/getsockopt ` | `CGROUP_SOCKOPT` |
| `cgroup/setsockopt ` | `CGROUP_SOCKOPT` |
| `struct_ops+ ` | `STRUCT_OPS` |
| `sk_lookup` | `SK_LOOKUP` |

> `type/` always has to have proper `SEC("type/extras")` form,
`type+` means it can be either exact `SEC("type")` or well-formed `SEC("type/extras")` with proper '/' separator,
~~`type/`~~ indicates the section name is deprecated.


[^1]: Refer to [libbpf.c](https://github.com/libbpf/libbpf/blob/master/src/libbpf.c) to get the list.

[libbpf-bootstrap]: https://github.com/libbpf/libbpf-bootstrap
